# AmneziaWG 2.0 — модули ядра для Keenetic

Готовые модули ядра [AmneziaWG](https://docs.amnezia.org/ru/documentation/amnezia-wg/) 2.0 для роутеров Keenetic.

> **5 сборок MIPS покрывают все MIPS-модели (61 роутер)**
>
> **3 сборки AArch64 покрывают все ARM64-модели (15 роутеров)**

---

## Совместимость

### MIPS

| Сборка | Файл модуля | Утилита | Модели |
|---|---|---|---|
| **MT7621** | `amneziawg-MIPSEL-MT7621.ko` | `awg-mipsle` | KN-1010, 1011, 1810, 1910, 1913, 2310, 2311, 2610, 2810, 2910, 2911, 3010, 3013, 3410, 3510 |
| **MT7628** | `amneziawg-MIPSEL-MT7628.ko` | `awg-mipsle` | KN-1110, 1111, 1112, 1121, 1210–1221, 1310–1311, 1410, 1510–1511, 1610–1621, 1710–1721, 2210–2212, 3210–3311, 4910 |
| **EN7512** | `amneziawg-MIPS-EN7512.ko` | `awg-mips` | KN-2010, 2011, 2012, 2110, 2111 |
| **EN7516** | `amneziawg-MIPS-EN7516.ko` | `awg-mips` | KN-2112, 2410, 2510, 3610 |
| **EN7528** | `amneziawg-MIPSEL-EN7528.ko` | `awg-mipsle` | KN-1912, 3012, 3710, 3810 |

### AArch64

| Файл модуля | Утилита | Модель | Название |
|---|---|---|---|
| `amneziawg-AARCH64-MT7622.ko` | `awg-arm64` | KN-1811 | Ultra / Titan |
| | | KN-2710 | Peak |
| `amneziawg-AARCH64-MT7981.ko` | `awg-arm64` | KN-1012 | Giga / Hero |
| | | KN-2312 | Hopper 4G+ |
| | | KN-3411 | Buddy 6 |
| | | KN-3711 | Sprinter |
| | | KN-3712 | Sprinter SE |
| | | KN-3811 | Hopper |
| | | KN-3812 | Hopper SE |
| | | KN-3910 | Challenger |
| | | KN-3911 | Challenger SE |
| | | KN-4010 | Racer |
| | | KN-4410 | Buddy 6 SE |
| `amneziawg-AARCH64-MT7988.ko` | `awg-arm64` | KN-1812 | Ultra / Titan |

---

## Требования

- Роутер Keenetic с установленным **Entware**
- USB-накопитель, подключённый к роутеру (на нём работает Entware)
- Готовый конфигурационный файл AmneziaWG (`.conf`)

---

## Установка

### Шаг 1. Скачайте файлы

Из этого репозитория скачайте на свой компьютер **три файла**:

1. **Модуль ядра** (`.ko`) — найдите свою модель роутера (KN-XXXX) в таблицах выше и скачайте соответствующий файл
2. **Утилита `awg`** — в той же строке таблицы указано какой файл скачать (`awg-arm64`, `awg-mipsle` или `awg-mips`)
3. **Скрипт запуска** — файл `S51awg_tunnel`

### Шаг 2. Переименуйте файлы

На своём компьютере переименуйте скачанные файлы:

| Скачанный файл | Переименовать в |
|---|---|
| `amneziawg-XXXXX-XXXXX.ko` | `amneziawg.ko` |
| `awg-arm64` / `awg-mipsle` / `awg-mips` | `awg` |
| Ваш конфигурационный файл `.conf` | `awgk0.conf` |

Файл `S51awg_tunnel` переименовывать **не нужно**.

### Шаг 3. Подключитесь к роутеру по SSH

Entware на Keenetic работает на порту **222**.

Windows 10/11 имеет встроенный SSH-клиент. Откройте **Командную строку** или **PowerShell** и выполните:

```
ssh root@192.168.1.1 -p 222
```

Пароль — тот, что вы задали при настройке Entware (по умолчанию: `keenetic`).

### Шаг 4. Создайте папку для файлов

В SSH выполните:

```bash
mkdir -p /opt/etc/awg
```

### Шаг 5. Загрузите файлы на роутер

1. Откройте веб-интерфейс роутера: http://my.keenetic.net
2. Перейдите в **Приложения** → выберите накопитель, на котором установлен Entware

**Загрузите модуль, утилиту и конфигурацию:**

3. Перейдите в папку `opt` → `etc` → `awg`
4. Нажмите **«Загрузить»** и загрузите три файла:
   - `amneziawg.ko`
   - `awg`
   - `awgk0.conf`

**Загрузите скрипт запуска:**

5. Вернитесь в папку `opt` → `etc` → `init.d`
6. Нажмите **«Загрузить»** и загрузите файл `S51awg_tunnel`

### Шаг 6. Сделайте файлы исполняемыми и установите необходимые утилиты

Вернитесь в SSH и выполните:

```bash
chmod +x /opt/etc/awg/awg
chmod +x /opt/etc/init.d/S51awg_tunnel
opkg install ip-full iptables curl
```

### Шаг 7. Запустите туннель

```bash
/opt/etc/init.d/S51awg_tunnel start
```

Проверьте, что интерфейс создан:

```bash
ip a show awgk0
```

Проверьте подключение через туннель:

```bash
curl --interface awgk0 2ip.io
```

Если всё работает — вы увидите IP-адрес VPN-сервера.

---

## Управление туннелем

```bash
# Остановить
/opt/etc/init.d/S51awg_tunnel stop

# Перезапустить
/opt/etc/init.d/S51awg_tunnel restart
```

---

## Автозапуск

Скрипт расположен в `/opt/etc/init.d/` с префиксом `S51` — Entware автоматически запустит его при загрузке роутера. Дополнительная настройка не требуется.

---

## Устранение неполадок

| Проблема | Решение |
|---|---|
| `insmod: can't insert module` | Скачан не тот `.ko`-файл. Проверьте модель роутера в таблице совместимости |
| `RTNETLINK: Operation not supported` | Модуль ядра не загружен. Выполните `insmod /opt/etc/awg/amneziawg.ko` |
| `Failed to apply configuration` | Ошибка в конфигурационном файле. Проверьте содержимое `awgk0.conf` |
| Нет интернета после запуска | Проверьте, что VPN-сервер доступен. Выполните `curl --interface awgk0 2ip.io` |
| `awg: not found` | Файл `awg` не загружен или не исполняемый. Выполните `chmod +x /opt/etc/awg/awg` |
| `Permission denied` | Скрипт не исполняемый. Выполните `chmod +x /opt/etc/init.d/S51awg_tunnel` |
| 'Фризы\лаги в популярных видеосервисах | Необходимо изменить значение MTU. Отредактируйте строку MTU в скрипте запуска, уменьшайте значение по 5|

---

## Благодарности

- **LionEvil** — за исходный скрипт запуска туннеля
